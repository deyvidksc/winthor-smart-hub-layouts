name: "CI/CD - Atualizar Version.json"

on:
  workflow_run:
    workflows: ["CI/CD - Criar Tag de Release"]
    branches:
      - main
      - develop
    types:
       - completed
       - success

permissions:
  contents: write  # Permite ao GITHUB_TOKEN fazer push para o repositório

jobs:
  update-version-json:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Carregar a versão atual
        run: |
          # A versão será passada como variável de ambiente do workflow anterior
          echo "NEW_VERSION=${{ github.event.workflow_run.outputs.NEW_VERSION }}" >> $GITHUB_ENV
          # Imprimir para depuração
          echo "Versão recebida do workflow anterior: ${{ github.event.workflow_run.outputs.NEW_VERSION }}"

      - name: Verificar o status do repositório
        run: |
          # Verifica o status e as alterações atuais do repositório
          git status
          git log --oneline --decorate -n 5

      - name: Obter arquivos modificados
        run: |
          # Lista todos os arquivos modificados
          git diff --name-only ${{ github.event.workflow_run.head_commit }} | sort > changed_files.txt
          cat changed_files.txt  # Para depuração

      - name: Extrair as pastas modificadas
        run: |
          # Extrai as pastas a partir dos arquivos modificados
          MODIFIED_FOLDERS=$(awk -F/ '{print $1}' changed_files.txt | sort -u)
          echo "Pastas modificadas: $MODIFIED_FOLDERS"
          echo "MODIFIED_FOLDERS=$MODIFIED_FOLDERS" >> $GITHUB_ENV

      - name: Atualizar version.json nas pastas modificadas
        run: |
          NEW_VERSION="${{ env.NEW_VERSION }}"
          MODIFIED_FOLDERS="${{ env.MODIFIED_FOLDERS }}"

          for folder in $MODIFIED_FOLDERS; do
            # Ignorar as pastas não desejadas
            if [[ "$folder" == ".github" || "$folder" == "version-control" ]]; then
              continue
            fi

            # Verifica se existe um arquivo version.json dentro da pasta
            VERSION_JSON_PATH="$folder/version.json"
            if [[ -f "$VERSION_JSON_PATH" ]]; then
              echo "Atualizando $VERSION_JSON_PATH com a versão $NEW_VERSION"
              # Atualiza a versão dentro do version.json
              jq ".versao = \"$NEW_VERSION\"" $VERSION_JSON_PATH > temp_version.json && mv temp_version.json $VERSION_JSON_PATH
              git add $VERSION_JSON_PATH
            else
              echo "Arquivo version.json não encontrado em $folder"
            fi
          done

      - name: Commit e Push das alterações no version.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Fazer pull para integrar as mudanças do repositório remoto
          git pull origin ${{ github.ref }} --rebase

          # Verifica se há alterações para commitar
          git diff --exit-code || git commit -m "Atualizando version.json para versão ${{ env.NEW_VERSION }}"

          # Push se houver alterações com o GITHUB_TOKEN
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }} ${{ github.ref }} || echo "Nenhuma alteração para push"
